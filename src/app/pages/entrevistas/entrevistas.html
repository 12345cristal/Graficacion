<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div>
            <h1>Entrevistas</h1>
            <p>GestiÃ³n y ejecuciÃ³n de entrevistas</p>
        </div>

        <button class="btn-crear" (click)="abrirModal()">
            + Crear Entrevista
        </button>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button
            [class.activo]="vistaActiva === 'entrevistas'"
            (click)="cambiarVista('entrevistas')">
            Entrevistas
        </button>

        <button
            [class.activo]="vistaActiva === 'historial'"
            (click)="cambiarVista('historial')">
            Historial de Ejecuciones
        </button>
    </div>

    @if (vistaActiva === 'entrevistas') {

    <div class="buscador">
        <input
            type="text"
            placeholder="Buscar entrevistas..."
            [(ngModel)]="busqueda">
    </div>

    @for (entrevista of entrevistasFiltradas; track entrevista.id) {

    <div class="card">

        <div class="card-header">
            <div>
                <h3>{{ entrevista.nombre }}</h3>
                <span class="badge">
                    {{ entrevista.preguntas.length }} preguntas
                </span>
            </div>

            <div class="acciones">
                <button
                    class="btn-ejecutar"
                    (click)="abrirModalEjecucion(entrevista)">
                    â–¶ Ejecutar
                </button>

                <button
                    class="btn-editar"
                    (click)="abrirModalEditar(entrevista)">
                    âœ Editar
                </button>

                <span
                    class="icon"
                    (click)="eliminarEntrevista(entrevista.id)">
                    ğŸ—‘
                </span>
            </div>
        </div>

        <div class="preguntas">
            <p><strong>Preguntas:</strong></p>
            <ol>
                @for (p of entrevista.preguntas; track $index) {
                <li>{{ p.texto }}</li>
                }
            </ol>
        </div>

    </div>
    }

    }

    @if (vistaActiva === 'historial') {

    @for (item of historial; track item.folio) {

    <div class="card historial">

        <div class="historial-content">
            <div>
                <div class="folio-fecha">
                    <span class="folio">{{ item.folio }}</span>
                    <span class="fecha-hora">{{ item.fecha }}</span>
                </div>
                <h3>{{ item.entrevista }}</h3>
                <div class="meta">
                    <span>ğŸ‘¤ <strong>Stakeholder:</strong> {{ item.stakeholder
                        }}</span>
                    <span>ğŸ“‹ <strong>Responsable:</strong> {{ item.responsable
                        }}</span>
                </div>
            </div>

            <button
                class="btn-detalles"
                (click)="verDetallesEjecucion(item)">
                ğŸ‘ Ver Detalles
            </button>
        </div>

    </div>
    }

    }

</div>

<!-- MODAL CREAR/EDITAR ENTREVISTA -->
@if (modalAbierto) {

<div class="modal-overlay">

    <div class="modal">

        <div class="modal-header">
            <h2>{{ editandoEntrevistaId ? 'Editar Entrevista' :
                'Nueva Entrevista' }}</h2>
            <span class="cerrar"
                (click)="cerrarModal()">âœ•</span>
        </div>

        <div class="modal-body">

            <label>Nombre de la Entrevista</label>
            <input
                type="text"
                placeholder="Ej: Entrevista - Product Owner"
                [(ngModel)]="nuevaEntrevista.nombre">

            <label>Preguntas</label>

            @for (pregunta of nuevaEntrevista.preguntas; track $index) {

            <div class="pregunta-input">

                <input
                    type="text"
                    placeholder="Escribe la pregunta"
                    [(ngModel)]="pregunta.texto">

                <button
                    class="eliminar-pregunta"
                    (click)="eliminarPregunta($index)">
                    âœ•
                </button>

            </div>
            }

            <button class="btn-agregar"
                (click)="agregarPregunta()">
                + Agregar pregunta
            </button>

        </div>

        <div class="modal-footer">
            <button class="btn-cancelar"
                (click)="cerrarModal()">
                Cancelar
            </button>

            <button class="btn-guardar"
                (click)="guardarEntrevista()">
                {{ editandoEntrevistaId ? 'Actualizar' : 'Guardar' }}
            </button>
        </div>

    </div>

</div>
}

<!-- MODAL EJECUTAR ENTREVISTA -->
@if (modalEjecucionAbierto && entrevistaAEjecutar) {

<div class="modal-overlay">

    <div class="modal">

        <!-- SELECTOR DE STAKEHOLDER -->
        @if (!respondiendo) {

        <div class="modal-header">
            <h2>Ejecutar Entrevista: {{ entrevistaAEjecutar.nombre }}</h2>
            <span class="cerrar"
                (click)="cerrarModalEjecucion()">âœ•</span>
        </div>

        <div class="modal-body">

            <label>Seleccionar Stakeholder Existente</label>
            <select [(ngModel)]="stakeholderSeleccionado"
                class="select-stakeholder">
                <option value>-- Seleccionar un stakeholder --</option>
                @for (sh of stakeholders; track sh.id) {
                <option [value]="sh.id">{{ sh.nombre }} ({{ sh.descripcion
                    }})</option>
                }
            </select>

            <div class="divider-o">
                <span>O</span>
            </div>

            <label>Crear Nuevo Stakeholder</label>
            <input
                type="text"
                placeholder="Nombre del stakeholder"
                [(ngModel)]="nuevoStakeholder">

        </div>

        <div class="modal-footer">
            <button class="btn-cancelar"
                (click)="cerrarModalEjecucion()">
                Cancelar
            </button>

            <button class="btn-comenzar"
                (click)="comenzarEntrevista()">
                Comenzar Entrevista
            </button>
        </div>

        }

        <!-- FORMULARIO DE RESPUESTAS -->
        @if (respondiendo && preguntaActual) {

        <div class="modal-header">
            <h2>Ejecutar Entrevista: {{ entrevistaAEjecutar.nombre }}</h2>
            <span class="cerrar"
                (click)="cerrarModalEjecucion()">âœ•</span>
        </div>

        <div class="modal-body modal-respuestas">

            <!-- Stakeholder seleccionado -->
            <div class="stakeholder-seleccionado">
                <strong>Stakeholder:</strong>
                <span>{{ stakeholderSeleccionadoNombre }}</span>
                <a href="#" class="enlace-cambiar"
                    (click)="respondiendo = false; $event.preventDefault()">
                    + Cambiar Stakeholder
                </a>
            </div>

            <!-- Indicador de progreso -->
            <div class="indicador-progreso">
                <span class="numero-pregunta">Pregunta {{ indicePreguntaActual +
                    1 }} de {{ totalPreguntas }}</span>
                <span class="nombre-stakeholder">{{
                    stakeholderSeleccionadoNombre }}</span>
            </div>

            <!-- Barra de progreso -->
            <div class="progress-bar">
                <div class="progress"
                    [style.width.%]="((indicePreguntaActual + 1) / totalPreguntas) * 100">
                </div>
            </div>

            <!-- Pregunta -->
            <div class="pregunta-container">
                <h3>{{ preguntaActual.preguntaTexto }}</h3>
            </div>

            <!-- Campo de respuesta -->
            <div class="respuesta-container">
                <label>Respuesta</label>
                <textarea
                    placeholder="Escribe la respuesta aquÃ­..."
                    [(ngModel)]="preguntaActual.respuesta"
                    rows="4"
                    class="textarea-respuesta">
                </textarea>
            </div>

        </div>

        <div class="modal-footer">
            <button class="btn-anterior"
                (click)="irAAnteriorPregunta()"
                [disabled]="indicePreguntaActual === 0">
                â† Anterior
            </button>

            @if (indicePreguntaActual === totalPreguntas - 1) {
            <button class="btn-finalizar"
                (click)="finalizarRespuestas()">
                Finalizar
            </button>
            } @else {
            <button class="btn-siguiente"
                (click)="irASiguientePregunta()">
                Siguiente â†’
            </button>
            }
        </div>

        }

    </div>

</div>
}

<!-- MODAL DETALLES EJECUCIÃ“N -->
@if (modalDetallesAbierto && detallesEjecucion) {

<div class="modal-overlay">

    <div class="modal modal-detalles">

        <div class="modal-header">
            <h2>Detalles de la Entrevista</h2>
            <span class="cerrar"
                (click)="cerrarModalDetalles()">âœ•</span>
        </div>

        <div class="modal-body">

            <div class="detalle-item">
                <span class="label">Folio</span>
                <span class="badge badge-folio">{{ detallesEjecucion.folio
                    }}</span>
            </div>

            <div class="detalle-item">
                <span class="label">Entrevista</span>
                <span class="valor">{{ detallesEjecucion.entrevista }}</span>
            </div>

            <div class="detalle-item">
                <span class="label">Stakeholder</span>
                <span class="valor">{{ detallesEjecucion.stakeholder }}</span>
            </div>

            <div class="detalle-item">
                <span class="label">Responsable</span>
                <span class="valor">{{ detallesEjecucion.responsable }}</span>
            </div>

            <div class="detalle-item">
                <span class="label">Fecha y Hora</span>
                <span class="valor">{{ detallesEjecucion.fecha }}</span>
            </div>

            <div class="preguntas-respuestas">
                <h3>Preguntas y Respuestas</h3>

                @if (detallesEjecucion.respuestas &&
                detallesEjecucion.respuestas.length > 0) {
                @for (item of detallesEjecucion.respuestas; track $index) {
                <div class="pregunta-respuesta">
                    <p><strong>{{ $index + 1 }}. {{ item.preguntaTexto
                            }}</strong></p>
                    <p class="respuesta">{{ item.respuesta || '(Sin respuesta)'
                        }}</p>
                </div>
                }
                } @else {
                <p class="sin-datos">Sin respuestas registradas</p>
                }
            </div>

        </div>

        <div class="modal-footer">
            <button class="btn-cerrar"
                (click)="cerrarModalDetalles()">
                Cerrar
            </button>
        </div>

    </div>

</div>
}
